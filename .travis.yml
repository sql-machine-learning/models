dist: xenial
cache: pip
branches:
  only:
  - master
  - develop
  # https://docs.travis-ci.com/user/customizing-the-build/#safelisting-or-blocklisting-branches
  # safe list can prevent tag building, add rexp to detect tag
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"

language: python
python:
- 3.6
- 3.7

service:
  - docker

install:
- python setup.py -q install

jobs:
  include:
    - stage: UnitTest
      script:
        - python setup.py -q test
    - state: ElasticDLTest
      script:
        - cd base_image && docker build -t sqlflow/modelzoo_base . && cd ..
        - cd sqlflow_models && docker build -t sqlflow/sqlflow_models . && cd ..
        - curl -s https://github.com/sql-machine-learning/elasticdl/blob/4a995fe7eaf91bc5a9d50181e9aaaa14d15c8a09/scripts/setup_k8s_env.sh | bash
        - docker run --rm -it --net=host -v $HOME/.kube:/root/.kube -v /home/$USER/.minikube/:/home/$USER/.minikube/ sqlflow/sqlflow_models bash -c "elasticdl train --image_base=sqlflow/sqlflow_models --model_def=sqlflow_models.DNNClassifier --training_data=/data/mnist/train --validation_data=/data/mnist/test"



# elasticdl train --image_base=sqlflow/sqlflow_models \
# --model_def=sqlflow_models.DNNClassifier \
# --training_data=/work/scripts/data \
# --validation_data=/work/scripts/data \
# --minibatch_size=1 \
# --model_zoo=/sqlflow_models \
# --job_name=testrun \
# --num_minibatches_per_task=5