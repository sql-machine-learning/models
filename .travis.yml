dist: xenial
cache: pip
branches:
  only:
  - master
  - develop
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
language: python
python:
- 3.6
- 3.7
service:
- docker
install:
- python setup.py -q install
jobs:
  include:
  - stage: UnitTest
    script:
    - python setup.py -q test
  - state: ElasticDLTest
    script:
    - cd base_image && docker build -t sqlflow/modelzoo_base . && cd ..
    - cd sqlflow_models && docker build -t sqlflow/sqlflow_models . && cd ..
    - curl -s https://github.com/sql-machine-learning/elasticdl/blob/4a995fe7eaf91bc5a9d50181e9aaaa14d15c8a09/scripts/setup_k8s_env.sh
      | bash
    - docker run --rm -it --net=host -v $HOME/.kube:/root/.kube -v /home/$USER/.minikube/:/home/$USER/.minikube/
      -e ODPS_ACCESS_ID=$ODPS_ACCESS_ID -e ODPS_ACCESS_KEY=$ODPS_ACCESS_KEY sqlflow/sqlflow_models bash -c "elasticdl train --image_base=sqlflow/sqlflow_models
      --model_def=sqlflow_models.DNNClassifier --training_data=iris.train --dataset_fn=iris_dataset_fn --data_reader_params='columns=["sepal_length", "sepal_width", "petal_length", "petal_width", "class"]'
      --envs='ODPS_PROJECT_NAME=gomaxcompute_driver_w7u,ODPS_ACCESS_ID=$ODPS_ACCESS_ID,ODPS_ACCESS_KEY=$ODPS_ACCESS_KEY' --minibatch_size=1 --model_zoo=/sqlflow_models --job_name=testrun --num_minibatches_per_task=2 --image_pull_policy=Never"
env:
  global:
  - secure: BGbJyf7MERjVsTzP3/DPjYQo4eLOIi5KruhvMTZNp93e3uInI/dAgIg22IS1jNg1+x0pg5gSQaLGNWfJOwD+pMAUe1Ie0LZ2L6cgAti11hWsgbC+NsoouY7phopvFzADPsfjUyd+OQER2cRi41Kvffz35ic7tGeJICCu8Ly9R60SqYjsLgeP4xJocslKLTIEHyMVAZADWXMbNJ/L6xMvuz1aqWkEY23CDzk6U4ZmpnkjYquIdqS6+seswOTJlbJBnGJFb+DC1xng9ETsAfIO/jEhQj0uPIHoX2bGgjqzrkbBbcTgYZTgSikJ9S0Wl+TvAaDRL6IY6Cigdt0VpRvO4T71HT5xq6cATNbilVQ/E8o7vOGOhb3fqzCbknpUyk7CBGlcNmZ5wahajdcFumxPCwMOykk/qJWeCS4uS0O85glwREoM88H7JU3TGyOwFpnliGA33swhS5Cv3LI6vJ1AWgcUTIy2a9+0FQMkCkve9gb4ruViouD/lqG4i4zIy8ic+h4snYWuWvFb6XtduFZR8zgDdkbv9asjvA24gnJxItq1g91+P/FyOaEaMK1OAy6yeSm55rID6GnvK7Ld3VLbYrixyqPcnTBDhINlxhmXLV43+Unt7DtuchQLCVEJbXVp6m9KeCkPCV3TNfWS1dhL0F06uv7mtqk1rAMOyPRZuf0=
  - secure: zGB3hSMZl5I2T+9xulqsMBCoR18f2txaARuXxAnSw5fs6TW5ZhKc04nuTg9V7Ee1722WXFJjOJfvVGPOy9wtNG0jwY5aRfrmE98g+CnSAHMy9lgrBkteH3PnQurMS0WXjhzvb5tc8hLYGX+xHNIu2yJTe1DiYpGyLd0dBXUuqBgqGB7OEWKdbblB0yK0OJ39pYmurB1P7fh34Ir5hBTJWYsaE5WSKuXdfdwMcogdKffweLRtbYYLkGy8Vtsybium48aVKw9SC7B2/6n1ayUvA0MQtkDApXhoRhqCFHjSmNiQs/fsUnLY5FQCrhGHqY9aA/QZkTPE9DCMWvzXnhLDaUZC6k0uNTRA6MbWU/nyfaxoda3c+dmCxeoN8UJA5+ww1SftnJw9NJQDaPB4pg+9gllxpsVA4OHia0pBmQtnrMhZpn9EDn0Bv46a68TPSPjYhlF8fsHYx2gL1udqag02bS/ZYAuv/uLcpqrowDg+mStoqRui2w3pIG+g6rV5UsqlX7xZtDE8TzuxD9Hqu1knBUeDvc9YAmDRFXCLsE0r/vhiir4S6QDcAV3RulKXvIIVqq0AQLV0oCombfZ/RM8jWjfT5Dx9EiT3q/QfZRwQo4d3AFQqoqqT0E9eX7BLDwyt0285I3OSH4jJX/tW5gyUdminqCUw1fMIEFUGj+YDr3g=
